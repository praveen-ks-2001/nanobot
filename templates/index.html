<!DOCTYPE html>
<html lang="en" class="dark">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>nanobot</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link
    href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&family=JetBrains+Mono:wght@400;500&display=swap"
    rel="stylesheet">
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      darkMode: 'class',
      theme: {
        extend: {
          fontFamily: {
            sans: ['Inter', 'system-ui', 'sans-serif'],
            mono: ['JetBrains Mono', 'monospace'],
          },
          colors: {
            background: '#050505',
            surface: '#0F0F0F',
            surface2: '#1A1A1A',
            border: '#2A2A2A',
            accent: '#3B82F6',
          }
        }
      }
    };
  </script>
  <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
  <style>
    [x-cloak] {
      display: none !important;
    }

    body {
      background-color: #050505;
      color: #E5E5E5;
      font-family: 'Inter', sans-serif;
      -webkit-font-smoothing: antialiased;
    }

    /* Custom Scrollbar */
    ::-webkit-scrollbar {
      width: 6px;
      height: 6px;
    }

    ::-webkit-scrollbar-thumb {
      background: #333;
      border-radius: 3px;
    }

    ::-webkit-scrollbar-track {
      background: transparent;
    }

    /* Layout */
    .app-layout {
      display: grid;
      grid-template-columns: 260px 1fr;
      min-height: 100vh;
    }

    .sidebar {
      background: #050505;
      border-right: 1px solid #1f1f1f;
      position: sticky;
      top: 0;
      height: 100vh;
      display: flex;
      flex-direction: column;
    }

    /* Navigation Stepper */
    .nav-wrapper {
      position: relative;
      padding-left: 20px;
    }

    .nav-line {
      position: absolute;
      left: 27px;
      top: 12px;
      bottom: 12px;
      width: 1px;
      background: #1f1f1f;
      z-index: 0;
    }

    .nav-item {
      position: relative;
      display: flex;
      items-center;
      padding: 6px 0;
      cursor: pointer;
      color: #888;
      transition: color 0.2s;
      z-index: 1;
    }

    .nav-item:hover {
      color: #fff;
    }

    .nav-item.active {
      color: #fff;
      font-weight: 500;
    }

    .nav-dot {
      width: 15px;
      height: 15px;
      margin-right: 12px;
      background: #050505;
      border: 1px solid #333;
      border-radius: 50%;
      display: flex;
      items-center;
      justify-center;
      transition: all 0.2s;
    }

    .nav-item.active .nav-dot {
      border-color: #fff;
      background: #fff;
      box-shadow: 0 0 10px rgba(255, 255, 255, 0.2);
    }

    .nav-item.active .nav-dot::after {
      content: '';
      width: 5px;
      height: 5px;
      background: #000;
      border-radius: 50%;
    }

    .nav-label {
      font-size: 13px;
    }

    /* Cards & Content */
    .content-area {
      padding: 40px 60px;
      max-width: 1400px;
      margin: 0 auto;
    }

    .panel {
      background: #0F0F0F;
      border: 1px solid #1A1A1A;
      border-radius: 12px;
      padding: 24px;
      transition: border-color 0.2s;
    }

    .panel:hover {
      border-color: #2A2A2A;
    }

    .panel-header {
      font-size: 16px;
      font-weight: 500;
      margin-bottom: 16px;
      color: #fff;
      display: flex;
      items-center;
      justify-content: space-between;
    }

    .input-field {
      width: 100%;
      background: #080808;
      border: 1px solid #222;
      color: #ddd;
      padding: 10px 12px;
      border-radius: 8px;
      font-size: 13px;
      transition: border-color 0.2s;
    }

    .input-field:focus {
      outline: none;
      border-color: #444;
    }

    .input-label {
      display: block;
      font-size: 11px;
      text-transform: uppercase;
      color: #666;
      margin-bottom: 6px;
      letter-spacing: 0.5px;
    }

    /* Buttons */
    .btn {
      padding: 8px 16px;
      border-radius: 8px;
      font-size: 13px;
      font-weight: 500;
      transition: all 0.2s;
      display: inline-flex;
      items-center;
      gap: 8px;
    }

    .btn-primary {
      background: #fff;
      color: #000;
      hover: opacity-90;
    }

    .btn-primary:hover {
      background: #e5e5e5;
    }

    .btn-ghost {
      background: transparent;
      color: #888;
      border: 1px solid #222;
    }

    .btn-ghost:hover {
      border-color: #444;
      color: #fff;
    }

    /* Toggles */
    .toggle-checkbox {
      appearance: none;
      width: 36px;
      height: 20px;
      background: #222;
      border-radius: 20px;
      position: relative;
      cursor: pointer;
      transition: background 0.2s;
    }

    .toggle-checkbox::after {
      content: '';
      position: absolute;
      left: 2px;
      top: 2px;
      width: 16px;
      height: 16px;
      background: #666;
      border-radius: 50%;
      transition: transform 0.2s, background 0.2s;
    }

    .toggle-checkbox:checked {
      background: #fff;
    }

    .toggle-checkbox:checked::after {
      transform: translateX(16px);
      background: #000;
    }

    /* Logs */
    .terminal {
      font-family: 'JetBrains Mono', monospace;
      font-size: 12px;
      line-height: 1.6;
      color: #aaa;
      background: #080808;
      border: 1px solid #1A1A1A;
      border-radius: 8px;
      padding: 16px;
      height: 500px;
      overflow-y: auto;
    }

    .log-line {
      border-left: 2px solid transparent;
      padding-left: 8px;
    }

    .log-line:hover {
      border-left-color: #333;
      background: #0c0c0c;
      color: #ddd;
    }

    /* Status Indicator */
    .status-badge {
      width: 6px;
      height: 6px;
      border-radius: 50%;
      opacity: 0.6;
    }

    .status-badge.running {
      background: #10B981;
      box-shadow: 0 0 8px rgba(16, 185, 129, 0.4);
      opacity: 1;
    }

    .status-badge.stopped {
      background: #6B7280;
    }
  </style>
</head>

<body x-data="app()" x-init="init()" x-cloak>

  <div class="app-layout">

    <!-- Sidebar -->
    <aside class="sidebar">
      <div class="p-6 pb-2">
        <div class="flex items-center gap-3 mb-8">
          <div class="w-8 h-8 bg-white text-black rounded-lg flex items-center justify-center font-bold text-sm">NB
          </div>
          <div>
            <div class="font-medium text-sm">Nanobot</div>
            <div class="flex items-center gap-2 mt-1">
              <div class="status-badge" :class="status.gateway?.state || 'stopped'"></div>
              <span class="text-[10px] text-gray-500 uppercase tracking-wider"
                x-text="status.gateway?.state || 'OFFLINE'"></span>
            </div>
          </div>
        </div>

        <div class="text-[10px] text-gray-600 font-bold uppercase tracking-widest mb-4 pl-[26px]">Setup Workflow</div>

        <div class="nav-wrapper">
          <div class="nav-line"></div>

          <div class="nav-item" :class="view === 'overview' && 'active'" @click="view = 'overview'">
            <div class="nav-dot"></div>
            <span class="nav-label">Overview</span>
          </div>

          <div class="nav-item" :class="view === 'providers' && 'active'" @click="view = 'providers'">
            <div class="nav-dot"></div>
            <span class="nav-label">AI Providers</span>
          </div>

          <div class="nav-item" :class="view === 'channels' && 'active'" @click="view = 'channels'">
            <div class="nav-dot"></div>
            <span class="nav-label">Channels</span>
          </div>
        </div>

        <div class="text-[10px] text-gray-600 font-bold uppercase tracking-widest mt-8 mb-4 pl-[26px]">System</div>

        <div class="nav-wrapper">
          <div class="nav-item" :class="view === 'settings' && 'active'" @click="view = 'settings'">
            <div class="nav-dot" style="border-radius: 4px; width: 12px; height: 12px; margin-left: 2px;"></div>
            <span class="nav-label">Settings</span>
          </div>

          <div class="nav-item" :class="view === 'logs' && 'active'" @click="view = 'logs'">
            <div class="nav-dot" style="border-radius: 4px; width: 12px; height: 12px; margin-left: 2px;"></div>
            <span class="nav-label">Logs</span>
          </div>
        </div>
      </div>

      <div class="mt-auto p-6 border-t border-[#1A1A1A]">
        <div class="grid grid-cols-2 gap-2 mb-3">
          <button @click="startGateway()" :disabled="status.gateway?.state === 'running'"
            class="btn btn-ghost justify-center text-xs py-1.5 disabled:opacity-30">Start</button>
          <button @click="stopGateway()" :disabled="status.gateway?.state === 'stopped'"
            class="btn btn-ghost justify-center text-xs py-1.5 disabled:opacity-30 border-red-900/30 text-red-500 hover:border-red-500 hover:text-red-400">Stop</button>
        </div>
        <button @click="saveConfig()" class="btn btn-primary w-full justify-center">
          <span x-show="!saving">Save Changes</span>
          <span x-show="saving" class="opacity-50">Saving...</span>
        </button>
      </div>
    </aside>

    <!-- Main Content -->
    <main class="content-area" x-transition.opacity.duration.300ms>

      <!-- Overview -->
      <div x-show="view === 'overview'">
        <header class="mb-10">
          <h1 class="text-3xl font-light tracking-tight text-white mb-2">Overview</h1>
          <p class="text-gray-500 max-w-xl">Welcome to Nanobot. Configure your agents and monitor system health from
            this centralized dashboard.</p>
        </header>

        <!-- Setup Banner -->
        <div class="panel mb-8 bg-[#0A0A0A] border-[#222]" x-show="!isSetupComplete">
          <div class="flex items-start gap-4">
            <div
              class="w-8 h-8 rounded-full bg-white text-black flex items-center justify-center font-bold text-sm shrink-0">
              1</div>
            <div>
              <h3 class="text-white font-medium mb-1">Getting Started</h3>
              <p class="text-gray-500 text-sm mb-4 max-w-2xl">To activate your agent, connect an AI provider and enable
                a messaging channel.</p>
              <div class="flex gap-3">
                <button @click="view = 'providers'"
                  class="text-sm border-b border-gray-600 hover:border-white hover:text-white transition-colors pb-0.5"
                  :class="hasProvider ? 'text-emerald-500 border-emerald-500' : 'text-gray-400'">
                  1. Configure Provider <span x-show="hasProvider">âœ“</span>
                </button>
                <button @click="view = 'channels'"
                  class="text-sm border-b border-gray-600 hover:border-white hover:text-white transition-colors pb-0.5"
                  :class="hasChannel ? 'text-emerald-500 border-emerald-500' : 'text-gray-400'">
                  2. Enable Channel <span x-show="hasChannel">âœ“</span>
                </button>
              </div>
            </div>
          </div>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
          <div class="panel flex flex-col justify-between h-32">
            <div class="text-xs text-gray-500 uppercase tracking-wider">System Status</div>
            <div class="flex items-end justify-between">
              <span class="text-2xl text-white capitalize" x-text="status.gateway?.state || 'Unknown'"></span>
              <div class="status-badge" :class="status.gateway?.state || 'stopped'"></div>
            </div>
          </div>

          <div class="panel flex flex-col justify-between h-32 cursor-pointer hover:bg-[#151515] transition-colors"
            @click="view = 'providers'">
            <div class="text-xs text-gray-500 uppercase tracking-wider">Active Providers</div>
            <div class="flex items-end justify-between">
              <span class="text-2xl text-white" x-text="activeProviders.length"></span>
              <div class="flex -space-x-2">
                <template x-for="p in activeProviders">
                  <div
                    class="w-6 h-6 rounded-full bg-[#333] border border-black flex items-center justify-center text-[8px]"
                    x-text="p[0].toUpperCase()"></div>
                </template>
              </div>
            </div>
          </div>

          <div class="panel flex flex-col justify-between h-32 cursor-pointer hover:bg-[#151515] transition-colors"
            @click="view = 'channels'">
            <div class="text-xs text-gray-500 uppercase tracking-wider">Enabled Channels</div>
            <div class="flex items-end justify-between">
              <span class="text-2xl text-white" x-text="activeChannels.length"></span>
              <span class="text-xs text-gray-600">messaging platforms</span>
            </div>
          </div>
        </div>
      </div>

      <!-- Providers -->
      <div x-show="view === 'providers'">
        <header class="mb-10">
          <h1 class="text-3xl font-light tracking-tight text-white mb-2">AI Providers</h1>
          <p class="text-gray-500">Manage API keys and endpoints for LLM services.</p>
        </header>

        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
          <template x-for="p in providerList" :key="p.key">
            <div class="panel group" :class="{'border-white/20 bg-[#161616]': isProviderConfigured(p.key)}">
              <div class="flex items-center justify-between mb-4">
                <div class="flex items-center gap-3">
                  <div
                    class="w-8 h-8 rounded bg-[#222] flex items-center justify-center text-xs font-bold text-gray-400 group-hover:text-white transition-colors"
                    x-text="p.label[0]"></div>
                  <span class="font-medium text-gray-300" x-text="p.label"></span>
                </div>
                <div class="w-2 h-2 rounded-full" :class="isProviderConfigured(p.key) ? 'bg-emerald-500' : 'bg-[#222]'">
                </div>
              </div>
              <div class="space-y-3">
                <div>
                  <input type="password" class="input-field" :value="getProvider(p.key, 'apiKey')"
                    @input="setProvider(p.key, 'apiKey', $event.target.value)" placeholder="API Key">
                </div>
                <div x-show="p.hasBase">
                  <input type="text" class="input-field" :value="getProvider(p.key, 'apiBase')"
                    @input="setProvider(p.key, 'apiBase', $event.target.value)" placeholder="Base URL (Optional)">
                </div>
              </div>
            </div>
          </template>
        </div>
      </div>

      <!-- Channels -->
      <div x-show="view === 'channels'">
        <header class="mb-10">
          <h1 class="text-3xl font-light tracking-tight text-white mb-2">Channels</h1>
          <p class="text-gray-500">Connect to messaging platforms.</p>
        </header>

        <div class="space-y-4 max-w-3xl">
          <template x-for="(conf, key) in channelList" :key="key">
            <div class="panel flex flex-col gap-4">
              <div class="flex items-center justify-between">
                <div class="flex items-center gap-4">
                  <div class="w-10 h-10 rounded-lg bg-[#222] flex items-center justify-center text-lg"
                    x-text="getChannelIcon(key)"></div>
                  <div>
                    <h3 class="font-medium text-gray-200 capitalize" x-text="key"></h3>
                    <p class="text-xs text-gray-600" x-text="getChannelDesc(key)"></p>
                  </div>
                </div>
                <input type="checkbox" class="toggle-checkbox" x-model="config.channels[key].enabled">
              </div>

              <div x-show="config.channels[key].enabled"
                class="grid grid-cols-1 md:grid-cols-2 gap-4 pt-4 border-t border-[#222]" x-transition>
                <!-- Dynamic inputs based on channel type -->
                <template x-for="(val, field) in getChannelFields(key)" :key="field">
                  <div>
                    <label class="input-label" x-text="field"></label>
                    <input type="text" class="input-field" x-model="config.channels[key][field]">
                  </div>
                </template>
                <div>
                  <label class="input-label">Allowed User IDs</label>
                  <input type="text" class="input-field" :value="(config.channels[key].allowFrom || []).join(', ')"
                    @input="config.channels[key].allowFrom = $event.target.value.split(',').map(s => s.trim()).filter(Boolean)">
                </div>
              </div>
            </div>
          </template>
        </div>
      </div>

      <!-- Settings -->
      <div x-show="view === 'settings'">
        <header class="mb-10">
          <h1 class="text-3xl font-light tracking-tight text-white mb-2">Settings</h1>
          <p class="text-gray-500">System configuration and defaults.</p>
        </header>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-8 max-w-4xl">
          <div class="panel">
            <h3 class="panel-header">Agent Behaviour</h3>
            <div class="space-y-4">
              <div>
                <label class="input-label">Default Model</label>
                <input type="text" class="input-field" x-model="config.agents.defaults.model">
              </div>
              <div>
                <label class="input-label">Max Tokens</label>
                <input type="number" class="input-field" x-model.number="config.agents.defaults.maxTokens">
              </div>
              <div>
                <label class="input-label">Temperature</label>
                <input type="number" step="0.1" class="input-field" x-model.number="config.agents.defaults.temperature">
              </div>
            </div>
          </div>

          <div class="panel">
            <h3 class="panel-header">Tools & Environment</h3>
            <div class="space-y-4">
              <div>
                <label class="input-label">Brave Search API Key</label>
                <input type="password" class="input-field" x-model="config.tools.web.search.apiKey">
              </div>
              <div>
                <label class="input-label">Execution Timeout (s)</label>
                <input type="number" class="input-field" x-model.number="config.tools.exec.timeout">
              </div>
              <label class="flex items-center gap-3 pt-2">
                <input type="checkbox" class="toggle-checkbox" x-model="config.tools.exec.restrictToWorkspace"
                  style="width: 32px; height: 18px;">
                <span class="text-sm text-gray-400">Restrict File Access</span>
              </label>
            </div>
          </div>
        </div>
      </div>

      <!-- Logs -->
      <div x-show="view === 'logs'">
        <header class="mb-6 flex items-center justify-between">
          <h1 class="text-3xl font-light tracking-tight text-white">System Logs</h1>
          <button class="text-xs text-blue-500 hover:text-white transition-colors" @click="logs=[]; loadLogs()">Refresh
            / Clear</button>
        </header>
        <div class="terminal" x-ref="logViewer">
          <template x-for="line in logs">
            <div class="log-line" x-text="line"></div>
          </template>
          <div x-show="logs.length === 0" class="h-full flex items-center justify-center opacity-30">No logs available
          </div>
        </div>
      </div>

    </main>
  </div>

  <script>
    function app() {
      return {
        view: 'overview',
        config: defaultConfig(),
        status: {},
        logs: [],
        saving: false,

        // Computed Helpers
        get hasProvider() { return Object.values(this.status.providers || {}).some(p => p.configured); },
        get hasChannel() { return Object.values(this.status.channels || {}).some(c => c.enabled); },
        get isSetupComplete() { return this.hasProvider && this.hasChannel; },
        get activeProviders() { return Object.entries(this.status.providers || {}).filter(([, v]) => v.configured).map(([k]) => k); },
        get activeChannels() { return Object.entries(this.status.channels || {}).filter(([, v]) => v.enabled).map(([k]) => k); },

        // Lists
        providerList: [
          { key: 'anthropic', label: 'Anthropic', hasBase: false },
          { key: 'openai', label: 'OpenAI', hasBase: true },
          { key: 'openrouter', label: 'OpenRouter', hasBase: true },
          { key: 'deepseek', label: 'DeepSeek', hasBase: false },
          { key: 'groq', label: 'Groq', hasBase: false },
          { key: 'gemini', label: 'Gemini', hasBase: false },
        ],

        channelList: {
          telegram: { icon: 'âœˆï¸', desc: 'BotFather Token', fields: { token: '' } },
          whatsapp: { icon: 'ðŸ’¬', desc: 'Local Bridge', fields: { bridgeUrl: '' } },
          discord: { icon: 'ðŸŽ®', desc: 'Bot Token', fields: { token: '', appId: '' } },
          slack: { icon: 'ðŸ’¼', desc: 'App Token', fields: { token: '', signingSecret: '' } },
          feishu: { icon: 'ðŸ¦', desc: 'Lark/Feishu App', fields: { appId: '', appSecret: '' } },
          dingtalk: { icon: 'ðŸ¢', desc: 'DingTalk Robot', fields: { clientId: '', clientSecret: '' } },
          email: { icon: 'ðŸ“§', desc: 'SMTP Config', fields: { host: '', port: '', user: '', pass: '' } },
          mochat: { icon: 'ðŸ±', desc: 'WeChat Bot', fields: { apiUrl: '' } },
          qq: { icon: 'ðŸ§', desc: 'QQ Bot', fields: { token: '', appId: '' } }
        },

        getChannelIcon(key) { return this.channelList[key]?.icon || '#'; },
        getChannelDesc(key) { return this.channelList[key]?.desc || ''; },
        getChannelFields(key) { return this.channelList[key]?.fields || {}; },

        isProviderConfigured(key) {
          return this.status.providers?.[key]?.configured || (this.config.providers?.[key]?.apiKey?.length > 0);
        },
        getProvider(key, field) { return this.config.providers?.[key]?.[field] || ''; },
        setProvider(key, field, value) {
          if (!this.config.providers[key]) this.config.providers[key] = {};
          this.config.providers[key][field] = value;
        },

        async init() {
          this.loadConfig();
          this.loadStatus();
          this.loadLogs();
          setInterval(() => this.loadStatus(), 3000);
          setInterval(() => this.loadLogs(), 2000);
        },

        async loadConfig() {
          try {
            const res = await fetch('/api/config');
            if (res.ok) {
              const data = await res.json();
              this.config = mergeDeep(defaultConfig(), data);
            }
          } catch (e) { }
        },

        async saveConfig() {
          this.saving = true;
          try {
            // Ensure all channels exist in config structure before saving
            for (const key of Object.keys(this.channelList)) {
              if (!this.config.channels[key]) this.config.channels[key] = { enabled: false };
            }

            await fetch('/api/config', {
              method: 'PUT',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify(this.config)
            });
            await this.loadConfig();
            await this.loadStatus();
          } catch (e) { }
          this.saving = false;
        },

        async loadStatus() {
          try {
            const res = await fetch('/api/status');
            if (res.ok) this.status = await res.json();
          } catch (e) { }
        },

        async loadLogs() {
          try {
            const res = await fetch('/api/logs');
            if (res.ok) {
              const d = await res.json();
              this.logs = d.lines;
            }
          } catch (e) { }
        },

        async apiAction(action) { await fetch(`/api/gateway/${action}`, { method: 'POST' }); this.loadStatus(); },
        startGateway() { this.apiAction('start'); },
        stopGateway() { this.apiAction('stop'); }
      };
    }

    function defaultConfig() {
      return {
        agents: { defaults: { model: 'anthropic/claude-3-5-sonnet-20240620', maxTokens: 4096, temperature: 0.7 } },
        providers: {},
        channels: {},
        tools: { web: { search: { apiKey: '' } }, exec: { timeout: 30 } }
      };
    }

    function mergeDeep(target, source) {
      if (!source) return target;
      const output = { ...target };
      for (const key of Object.keys(source)) {
        if (source[key] instanceof Object && !Array.isArray(source[key])) {
          output[key] = mergeDeep(target[key] || {}, source[key]);
        } else {
          output[key] = source[key];
        }
      }
      return output;
    }
  </script>
</body>

</html>